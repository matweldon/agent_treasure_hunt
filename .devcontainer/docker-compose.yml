version: '3.8'

services:
  agent:
    build:
      context: ..
      dockerfile: Dockerfile

    volumes:
      # Mount the workspace
      - ..:/app:cached
      # Persistent volume for treasure hunts
      - treasure-hunt-data:/app/treasure_hunt

    # Security settings
    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    cap_add:
      - NET_BIND_SERVICE

    # Read-only root filesystem (with exceptions for writable areas)
    # Commented out for development flexibility
    # read_only: true

    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # GOOGLE_API_KEY should be set by user

    # Network configuration
    networks:
      - agent-network

    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Keep container running
    command: sleep infinity

networks:
  agent-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-agent
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  treasure-hunt-data:
